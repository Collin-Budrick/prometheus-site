{
	auto_https off
	servers :443 {
		protocols h1 h2 h3
	}
	servers :80 {
		protocols h1
	}
}
http://prometheus.dev, http://prometheus.prod {
	redir https://{host}{uri}
}

https://prometheus.dev {
	tls /etc/caddy/certs/prometheus.dev+prometheus.prod.pem /etc/caddy/certs/prometheus.dev+prometheus.prod.key
	header {
		alt-svc "h3=\":443\"; ma=2592000"
	}

	@static_cache path_regexp static_cache ^/(?:build|assets|icons)/|^/favicon\.[^/]+$|^/manifest\.webmanifest$
	handle @static_cache {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy http://192.168.1.138:4173 {
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}

	handle /yjs {
		reverse_proxy http://yjs-signaling:4444
	}

	handle_path /yjs/* {
		reverse_proxy http://yjs-signaling:4444
	}

	handle_path /api/* {
		reverse_proxy http://api:4000 {
			lb_try_duration 5s
			lb_try_interval 100ms
		}
	}

	@ai path_regexp ai ^/(?:[a-z]{2}/)?ai(?:/|$)
	handle @ai {
		header {
			Cross-Origin-Opener-Policy "same-origin"
			Cross-Origin-Embedder-Policy "require-corp"
		}
		reverse_proxy http://192.168.1.138:4173 {
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}

	handle {
		reverse_proxy http://192.168.1.138:4173 {
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}
}

https://prometheus.prod {
	tls /etc/caddy/certs/prometheus.dev+prometheus.prod.pem /etc/caddy/certs/prometheus.dev+prometheus.prod.key
	header {
		alt-svc "h3=\":443\"; ma=2592000"
	}

	encode br gzip
	@static_cache path_regexp static_cache ^/(?:build|assets|icons)/|^/favicon\.[^/]+$|^/manifest\.webmanifest$
	handle @static_cache {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}

	handle /yjs {
		reverse_proxy http://yjs-signaling:4444
	}

	handle_path /yjs/* {
		reverse_proxy http://yjs-signaling:4444
	}

	handle_path /api/* {
		reverse_proxy http://api:4000 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
		}
	}

	@ai path_regexp ai ^/(?:[a-z]{2}/)?ai(?:/|$)
	handle @ai {
		header {
			Cross-Origin-Opener-Policy "same-origin"
			Cross-Origin-Embedder-Policy "require-corp"
		}
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}

	handle {
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}
}
