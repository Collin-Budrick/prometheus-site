{
	auto_https off
	servers :443 {
		protocols h1 h2 h3
	}
	servers :80 {
		protocols h1
	}
}
http://prometheus.dev, http://prometheus.prod {
	redir https://{host}{uri}
}

https://prometheus.dev {
	tls /etc/caddy/certs/prometheus.dev+prometheus.prod.pem /etc/caddy/certs/prometheus.dev+prometheus.prod.key
	header {
		alt-svc "h3=\":443\"; ma=2592000"
	}

	encode br gzip
	handle /build/* {
		root * /srv/web/dist
		file_server {
			precompressed br gzip
		}
	}

	@static {
		path /assets/* /favicon.ico /favicon.svg /manifest.webmanifest /service-worker.js /q-manifest.json /robots.txt /sitemap.xml /icons/*
		file {
			root /srv/web/dist
			try_files {path} {path}.br {path}.gz
		}
	}
	handle @static {
		root * /srv/web/dist
		file_server {
			precompressed br gzip
		}
	}

	handle_path /api/* {
		reverse_proxy http://api:4000 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
		}
	}

	@ai path_regexp ai ^/(?:[a-z]{2}/)?ai(?:/|$)
	handle @ai {
		header {
			Cross-Origin-Opener-Policy "same-origin"
			Cross-Origin-Embedder-Policy "require-corp"
		}
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}

	handle {
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}
}

https://prometheus.prod {
	tls /etc/caddy/certs/prometheus.dev+prometheus.prod.pem /etc/caddy/certs/prometheus.dev+prometheus.prod.key
	header {
		alt-svc "h3=\":443\"; ma=2592000"
	}

	encode br gzip
	handle /build/* {
		root * /srv/web/dist
		file_server {
			precompressed br gzip
		}
	}

	@static {
		path /assets/* /favicon.ico /favicon.svg /manifest.webmanifest /service-worker.js /q-manifest.json /robots.txt /sitemap.xml /icons/*
		file {
			root /srv/web/dist
			try_files {path} {path}.br {path}.gz
		}
	}
	handle @static {
		root * /srv/web/dist
		file_server {
			precompressed br gzip
		}
	}

	handle_path /api/* {
		reverse_proxy http://api:4000 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
		}
	}

	@ai path_regexp ai ^/(?:[a-z]{2}/)?ai(?:/|$)
	handle @ai {
		header {
			Cross-Origin-Opener-Policy "same-origin"
			Cross-Origin-Embedder-Policy "require-corp"
		}
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}

	handle {
		reverse_proxy http://web:4173 {
			header_up -Accept-Encoding
			lb_try_duration 5s
			lb_try_interval 100ms
			header_down -X-Early-Hints
			@early_hints header X-Early-Hints *
			handle_response @early_hints {
				header Link "{http.reverse_proxy.header.X-Early-Hints}"
				respond 103
				copy_response
			}
		}
	}
}
